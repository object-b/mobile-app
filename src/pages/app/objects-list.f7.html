<template>
    <div class="page" data-name="objects-list">
        <div class="navbar">
            <div class="navbar-inner sliding">
                <div class="title">Список объектов</div>
                <div class="right">
                    <a href="/objects-filters" class="link">
                        <i class="f7-icons if-not-md">filter</i>
                        <i class="material-icons md-only">tune</i>
                        <span>Фильтры</span>
                    </a>
                </div>
            </div>
        </div>
        <div class="page-content">
            {{#if objects}}
            <div class="list media-list">
                <ul>
                    {{#each objects}}
                        <li>
                            <a href="/object/{{id}}" class="item-link item-content">
                                <div class="item-media">
                                    <img src="{{firstImage}}" width="120" />
                                </div>
                                <div class="item-inner">
                                    <div class="item-title-row">
                                        <div class="item-title trash-status-header">{{status}}</div>
                                    </div>
                                    <div class="item-subtitle">{{author}}</div>
                                    <div class="item-text">{{type}}</div>
                                    <div class="trash-card-footer">
                                        <div class="chip chip-outline trash-transport">
                                            <div class="chip-label">{{size}}</div>
                                        </div>
                                        <div class="item-after">{{date}}</div>
                                    </div>
                                </div>
                            </a>
                        </li>
                    {{/each}}
                </ul>
            </div>
            {{/if}}
        </div>

        <div class="fab fab-right-bottom">
            <a href="/create-object">
                <i class="icon f7-icons">add</i>
            </a>
        </div>
    </div>
</template>
<script>
    import { get, set } from 'idb-keyval';
    import * as config from '../../config';

    export default {
        data: function () {
            return {
                // empty initial data
                objects: null,
            }
        },
        on: {
            pageInit: function(e, page) {
                var self = this;
                var app = self.$app;
                var $$ = self.$$;

                app.preloader.show();

                // Запросить список объектов при инициализации страницы
                app.request.json(config.slimApiUrl + '/api/objects', (objects) => {
                    app.preloader.hide();

                    self.$setState({
                        objects: objects,
                    });
                }, self.$root.errorRequestHandler);

                // Android FAB hiding.
                // if (self.objects.length > 3) {
                //     $$('.page-content').on('scroll', handleScroll);
                // } else {
                //     $$('.fab').removeClass('fab-hidden');
                // }

                var previousScrollTop;
                var currentScrollTop;
                var scrollHeight;
                var offsetHeight;
                var reachEnd;
                var action;

                function handleScroll() {
                    const scrollContent = this;

                    currentScrollTop = scrollContent.scrollTop;
                    scrollHeight = scrollContent.scrollHeight;
                    offsetHeight = scrollContent.offsetHeight;
                    reachEnd = currentScrollTop + offsetHeight >= scrollHeight;

                    if (reachEnd) {
                        action = 'hide';
                    } else if (previousScrollTop > currentScrollTop) {
                        if (currentScrollTop <= 34) {
                            action = 'hide';
                        } else {
                            action = 'show';
                        }
                    } else if (currentScrollTop > 34) {
                        action = 'show';
                    } else {
                        action = 'hide';
                    }

                    if (action === 'show') {
                        $$('.fab').removeClass('fab-hidden');
                    } else if (action === 'hide') {
                        $$('.fab').addClass('fab-hidden');
                    }

                    previousScrollTop = currentScrollTop;
                }
            },
            pageBeforeIn: function (e, page) {
                var self = this;
                var $$ = self.$$;

                $$('.toolbar').show();
            },
        }
    }
</script>