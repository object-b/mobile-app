<template>
    <div class="page" data-name="objects-list">
        <div class="navbar">
            <div class="navbar-inner sliding">
                <div class="title">Список объектов</div>
                <div class="right">
                    <a href="/objects-filters" class="link">
                        <i class="f7-icons if-not-md">filter</i>
                        <i class="material-icons md-only">tune</i>
                        <span>Фильтры</span>
                    </a>
                </div>
            </div>
        </div>
        <div class="page-content infinite-scroll-content">
            {{#if objects}}
                <div class="list media-list trash-list">
                    <ul>
                        {{#each objects}}
                            <li class="trash-card">
                                <a href="/object/{{id}}" class="item-link item-content">
                                    <div class="item-media">
                                        <img src="{{firstImage}}" width="120" />
                                    </div>
                                    <div class="item-inner">
                                        <div class="item-title-row">
                                            <div class="item-title trash-status-header">{{status}}</div>
                                        </div>
                                        <div class="item-subtitle">{{type}}</div>
                                        <div class="item-text">{{size}}</div>
                                        <div class="trash-card-footer">
                                            <div>{{author}}</div>
                                            <div>{{date}}</div>
                                        </div>
                                    </div>
                                </a>
                            </li>
                        {{/each}}
                    </ul>
                </div>
                <div class="preloader infinite-scroll-preloader"></div>
            {{/if}}
        </div>

        <div class="fab fab-right-bottom">
            <a href="/create-object">
                <i class="icon f7-icons">add</i>
            </a>
        </div>
    </div>
</template>
<script>
    import { get, set } from 'idb-keyval';
    import helpers from '../../js/helpers';

    export default {
        data: function () {
            return {
                // empty initial data
                objects: null,
            }
        },
        on: {
            pageInit: function (e, page) {
                var previousScrollTop;
                var currentScrollTop;
                var scrollHeight;
                var offsetHeight;
                var reachEnd;
                var action;
                var self = this;
                var app = self.$app;
                var $$ = self.$$;
                
                var pageNumber = 1;
                var objectsGetUrl = app.data.config.slimApiUrl + '/api/objects?page=' + pageNumber;
                var allowInfinite = true;
                var mergedObjects = [];
                var currentObjects = [];

                // Срабатывает при достижении 50px внизу экрана
                $$('.infinite-scroll-content').on('infinite', function () {
                    // Выход, если загрузка в процессе
                    if (!allowInfinite) return;

                    allowInfinite = false;
                    
                    // Запросить следующую страницу
                    pageNumber++;
                    objectsGetUrl = app.data.config.slimApiUrl + '/api/objects?page=' + pageNumber;
                    
                    app.request.json(objectsGetUrl, (response) => {
                        app.preloader.hide();
                        // Загрузка завершена, разрешаем скроллинг
                        allowInfinite = true;

                        // Склеиваем текущие объекты и новые и присваиваем их в virtual DOM
                        currentObjects = self.objects;
                        mergedObjects = currentObjects.concat(response.data);

                        self.$setState({
                            objects: mergedObjects,
                        });

                        if (!response.hasMorePages) {
                            // Больше нечего загружать, уничтожить обработчик
                            app.infiniteScroll.destroy('.infinite-scroll-content');
                            // Удалить прелоадер внизу страницы
                            $$('.infinite-scroll-preloader').remove();
                            return;
                        }
                    }, self.$root.errorRequestHandler);
                });

                // Запросить первую страницу объектов при инициализации страницы
                app.preloader.show();

                app.request.json(objectsGetUrl, (response) => {
                    app.preloader.hide();

                    self.$setState({
                        objects: response.data,
                    });
                }, self.$root.errorRequestHandler);

                // Скрытие кнопки добавление как в обычном ведре
                // if (self.objects.length > 3) {
                //     $$('.page-content').on('scroll', helpers.handleScroll);
                // } else {
                //     $$('.fab').removeClass('fab-hidden');
                // }
            },
            pageBeforeIn: function (e, page) {
                this.$$('.toolbar').show();
            },
        }
    }
</script>