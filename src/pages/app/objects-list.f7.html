<template>
    <div class="page" data-name="objects-list">
        <div class="navbar">
            <div class="navbar-inner sliding">
                <div class="title">Список объектов</div>
                <div class="right">
                    <a href="/objects-filters" class="link">
                        <i class="f7-icons if-not-md">filter</i>
                        <i class="material-icons md-only">tune</i>
                        <span>Фильтры</span>
                    </a>
                </div>
            </div>
        </div>
        <div class="page-content">
            {{#if objects}}
            <!-- Show list when it is loaded -->
            <div class="list media-list">
                <ul>
                    {{#each objects}}
                    <li>
                        <a href="/object/{{this.id}}" class="item-link item-content">
                            <div class="item-media">
                                <img src="{{this.image}}" width="120" />
                            </div>
                            <div class="item-inner">
                                <div class="item-title-row">
                                    <div class="item-title trash-status-header">{{this.status}}</div>
                                </div>
                                <div class="item-subtitle">{{this.author}}</div>
                                <!-- <div class="item-text">{{this.type}}</div> -->
                                <div class="trash-card-footer">
                                    <!-- <div class="chip chip-outline trash-transport"> -->
                                        <!-- <div class="chip-label">{{this.size}}</div> -->
                                    <!-- </div> -->
                                    <div class="item-after">{{this.humanDate}}</div>
                                </div>
                            </div>
                        </a>
                    </li>
                    {{/each}}
                </ul>
            </div>
            {{/if}}
        </div>

        <div class="fab fab-right-bottom fab-hidden">
            <a href="/create-object">
                <i class="icon f7-icons">add</i>
            </a>
        </div>
    </div>
</template>
<script>
    import { get, set } from 'idb-keyval';
    import * as config from '../../config';

    export default {
        data: function () {
            return {
                // empty initial data
                objects: null,
            }
        },
        methods: {
            
        },
        // Page Events
        on: {
            pageInit: function(e, page) {
                var self = this;
                var app = self.$app;
                var $$ = self.$$;

                self.$root.setAccessTokenInRequest(localStorage.getItem('AUTH_TOKEN'));

                app.preloader.show();

                // request objects on page init
                app.request.json(config.slimApiUrl + '/api/objects', (objects) => {
                    app.preloader.hide();

                    self.$setState({
                        objects: objects,
                    });

                    // Remove me someday. Android FAB hiding.
                    // if (self.objects.length > 3) {
                    //     $$('.page-content').on('scroll', handleScroll);
                    // } else {
                    //     $$('.fab').removeClass('fab-hidden');
                    // }

                    $$('.fab').removeClass('fab-hidden');
                }, self.$root.errorRequestHandler);

                var previousScrollTop;
                var currentScrollTop;
                var scrollHeight;
                var offsetHeight;
                var reachEnd;
                var action;

                function handleScroll() {
                    const scrollContent = this;

                    currentScrollTop = scrollContent.scrollTop;
                    scrollHeight = scrollContent.scrollHeight;
                    offsetHeight = scrollContent.offsetHeight;
                    reachEnd = currentScrollTop + offsetHeight >= scrollHeight;

                    if (reachEnd) {
                        action = 'hide';
                    } else if (previousScrollTop > currentScrollTop) {
                        if (currentScrollTop <= 34) {
                            action = 'hide';
                        } else {
                            action = 'show';
                        }
                    } else if (currentScrollTop > 34) {
                        action = 'show';
                    } else {
                        action = 'hide';
                    }

                    if (action === 'show') {
                        $$('.fab').removeClass('fab-hidden');
                    } else if (action === 'hide') {
                        $$('.fab').addClass('fab-hidden');
                    }

                    previousScrollTop = currentScrollTop;
                }
            },
            pageBeforeIn: function (e, page) {
                this.$app.$('.toolbar').show();
            },
        }
    }
</script>