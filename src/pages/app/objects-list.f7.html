<template>
    <div class="page" data-name="objects-list">
        <div class="navbar">
            <div class="navbar-inner sliding">
                <div class="left">
                    <a href="#" class="link icon-only panel-open" data-panel="left">
                        <i class="icon f7-icons ios-only">menu</i>
                        <i class="icon material-icons md-only">menu</i>
                    </a>
                </div>
                <div class="title">Список</div>
                <div class="right">
                    <a href="/objects-filters" class="link">
                        <i class="f7-icons if-not-md">filter</i>
                        <i class="material-icons md-only">tune</i>
                        <span>Фильтры</span>
                    </a>
                </div>
            </div>
        </div>
        <div class="page-content infinite-scroll-content">
            {{#if objects}}
                <div class="list media-list trash-list">
                    <ul>
                        {{#each objects}}
                            <li class="trash-card">
                                <a href="/object/{{id}}" class="item-link item-content">
                                    <div class="item-media">
                                        <img src="{{firstImage}}" width="120" />
                                    </div>
                                    <div class="item-inner">
                                        <div class="item-title-row">
                                            <div class="item-title trash-status-header">{{status}}</div>
                                        </div>
                                        <div class="item-subtitle">{{type}}</div>
                                        <div class="item-text">{{size}}</div>
                                        <div class="trash-card-footer">
                                            <div>{{author}}</div>
                                            <div>{{date}}</div>
                                        </div>
                                    </div>
                                </a>
                            </li>
                        {{/each}}
                    </ul>
                </div>
                <div class="preloader infinite-scroll-preloader"></div>
            {{/if}}
        </div>

        <div class="fab fab-right-bottom">
            <a href="/create-object">
                <i class="icon f7-icons">add</i>
            </a>
        </div>
    </div>
</template>
<script>
    import * as helpers from '../../js/helpers';
    import * as database from '../../js/interface/objects';

    export default {
        data: function () {
            return {
                // empty initial data
                objects: null,
            }
        },
        on: {
            pageInit: function (e, page) {
                var self = this;
                var app = self.$app;
                var $$ = self.$$;
                var allowInfinite = true;
                var mergedObjects = [];
                var currentObjects = [];

                app.views.main.router.clearPreviousHistory();

                // Срабатывает при достижении 50px внизу экрана
                $$('.infinite-scroll-content').on('infinite', function () {
                    // Выход, если загрузка в процессе
                    if (!allowInfinite) return;

                    if (window.isOnline) {
                        $$('.infinite-scroll-preloader').show();
                    }

                    allowInfinite = false;

                    // Запросить следующую страницу
                    database.getObjects(function(objects) {
                        // Загрузка завершена, разрешаем скроллинг
                        allowInfinite = true;

                        // Склеиваем текущие объекты и новые для в virtual DOM
                        currentObjects = self.objects;
                        mergedObjects = currentObjects.concat(objects);

                        self.$setState({
                            objects: mergedObjects,
                        });

                        // Уничтожить обработчик только если объектов нет в онлайне
                        // Дело в том что соединение может восстановиться и скроллинг продолжит работу
                        if (!objects.length && window.isOnline) {
                            app.infiniteScroll.destroy('.infinite-scroll-content');
                            $$('.infinite-scroll-preloader').remove();
                            return;
                        }
                        // Для оффлайна просто скрыть если объектов нет
                        else if (!objects.length && !window.isOnline) {
                            $$('.infinite-scroll-preloader').hide();
                        }
                    }, function(status) {
                        app.data.config.debug && console.log(status);
                    });
                });

                if (window.isOnline) {
                    app.preloader.show();
                }

                // Запросить первую страницу объектов при инициализации страницы
                database.getObjects(function(objects) {
                    self.$setState({
                        objects: objects,
                    });

                    // Скрыть лоадер если объектов меньше 10
                    if (objects.length < 10) {
                        $$('.infinite-scroll-preloader').hide();
                    }
                }, function(status) {
                    app.data.config.debug && console.log(status);
                });
            },
        }
    }
</script>