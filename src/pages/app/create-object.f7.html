<template>
    <div class="page no-toolbar" data-name="object-create">
        <div class="navbar">
            <div class="navbar-inner sliding">
                <div class="left">
                    <a href="#" class="link back">
                        <i class="icon icon-back"></i>
                        <span class="ios-only">Назад</span>
                    </a>
                </div>
                <div class="right">
                    <a href="#" class="link" @click="submitCreateForm">
                        <span>Создать</span>
                    </a>
                </div>
            </div>
        </div>
        <div class="page-content">
        <form id="object-create-form">
            <div class="swiper-add-wrap">
                <div data-pagination='{"el": ".swiper-pagination"}' data-space-between="50" data-observer="true"
                    class="swiper-container swiper-init demo-swiper object-photo-slider object-create-slider-hidden">
                    <div class="swiper-pagination"></div>
                    <div class="swiper-wrapper">
                        {{#each photoUrls}}
                            <div class="swiper-slide">
                                <img src="{{this}}" class="uploaded-camera-image" width="1000" height="200" @click="openPhotoBrowser">
                            </div>
                        {{/each}}
                    </div>
                </div>
                <div class="demo-swiper object-photo-slider-empty" style="position: relative;">
                    <div class="swiper-wrapper">
                        <div class="swiper-slide hairline-bottom">
                            Вы должны добавить<br>как минимум одну фотографию
                        </div>
                    </div>
                </div>

                <div class="fab object-delete-photo" @click="deleteVisiblePhoto" hidden>
                    <a href="#">
                        <i class="f7-icons if-not-md">trash_fill</i>
                        <i class="material-icons md-only">delete</i>
                    </a>
                </div>
                <div class="fab object-add-photo" @click="launchCamera">
                    <a href="#">
                        <i class="f7-icons if-not-md">camera_fill</i>
                        <i class="material-icons md-only">add_a_photo</i>
                    </a>
                </div>
                <div class="fab object-attach-photo" @click="selectFromGallery">
                    <a href="#">
                        <i class="f7-icons if-not-md">attachment</i>
                        <i class="material-icons md-only">attach_file</i>
                    </a>
                </div>
            </div>

            <div class="block-title block-title-medium object-header header-address">
                <span>Адрес</span>
                <a class="link size-16" href="#" @click="changeMapPosition">
                    <span>Изменить точку на карте</span>
                </a>
            </div>
            
            <div class="card">
                <div id="user-location" class="create-object-map"></div>
                <div class="card-content card-content-padding">
                    <span id="user-location-display-name">Выберите локацию и адрес появится здесь</span>
                </div>
                <div class="card-footer object-coordinates">
                    <i class="f7-icons if-not-md size-20">home</i>
                    <i class="material-icons md-only size-20">place</i>
                    <span id="user-location-coordinates"></span>
                </div>
            </div>

            <div class="block-title block-title-medium object-header">Количество мусора</div>
            <div class="list">
                <ul>
                    <li>
                        <label class="item-radio item-content">
                            <input type="radio" name="trash_size" value="Мешок" checked>
                            <i class="icon icon-radio"></i>
                            <div class="item-inner">
                                <div class="item-title">Мешок</div>
                            </div>
                        </label>
                    </li>
                    <li>
                        <label class="item-radio item-content">
                            <input type="radio" name="trash_size" value="Тачка">
                            <i class="icon icon-radio"></i>
                            <div class="item-inner">
                                <div class="item-title">Тачка</div>
                            </div>
                        </label>
                    </li>
                    <li>
                        <label class="item-radio item-content">
                            <input type="radio" name="trash_size" value="Машина">
                            <i class="icon icon-radio"></i>
                            <div class="item-inner">
                                <div class="item-title">Машина</div>
                            </div>
                        </label>
                    </li>
                </ul>
            </div>

            <div class="block-title block-title-medium object-header">Тип мусора</div>
            <div class="list">
                <ul>
                    <li>
                        <label class="item-checkbox item-content">
                            <input type="checkbox" name="trash_type" value="Бычки" />
                            <i class="icon icon-checkbox"></i>
                            <div class="item-inner">
                                <div class="item-title">Бычки</div>
                            </div>
                        </label>
                    </li>
                    <li>
                        <label class="item-checkbox item-content">
                            <input type="checkbox" name="trash_type" value="Бумага" />
                            <i class="icon icon-checkbox"></i>
                            <div class="item-inner">
                                <div class="item-title">Бумага</div>
                            </div>
                        </label>
                    </li>
                    <li>
                        <label class="item-checkbox item-content">
                            <input type="checkbox" name="trash_type" value="Продукты" />
                            <i class="icon icon-checkbox"></i>
                            <div class="item-inner">
                                <div class="item-title">Продукты</div>
                            </div>
                        </label>
                    </li>
                    <li>
                        <label class="item-checkbox item-content">
                            <input type="checkbox" name="trash_type" value="Стекло" />
                            <i class="icon icon-checkbox"></i>
                            <div class="item-inner">
                                <div class="item-title">Стекло</div>
                            </div>
                        </label>
                    </li>
                    <li>
                        <label class="item-checkbox item-content">
                            <input type="checkbox" name="trash_type" value="Металл" />
                            <i class="icon icon-checkbox"></i>
                            <div class="item-inner">
                                <div class="item-title">Металл</div>
                            </div>
                        </label>
                    </li>
                    <li>
                        <label class="item-checkbox item-content">
                            <input type="checkbox" name="trash_type" value="Строительный" />
                            <i class="icon icon-checkbox"></i>
                            <div class="item-inner">
                                <div class="item-title">Строительный</div>
                            </div>
                        </label>
                    </li>
                </ul>
            </div>

            <div class="block-title block-title-medium object-header">Дополнительная информация</div>
            <div class="list no-hairlines-md">
                <ul>
                    <li class="item-content item-input">
                        <div class="item-inner no-padding-top">
                            <div class="item-input-wrap">
                                <textarea placeholder="Рядом остановка морг; это около шаурмечной; оно мешает моей собаке..." name="trash_description"></textarea>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </form>
        </div>
    </div>
</template>
<script>
    import * as config from '../../config';
    
    export default {
        data: function () {
            return {
                // empty initial object
                object: null,
                // created photos here (fileUri://)
                photoUrls: null,
                // instance of photo browser
                myPhotoBrowserPopup: null,
                // user geolocation here
                userLocation: null,
                // map html object
                map: null,
                // photo browser gallery
                photoBrowserSettings: {
                    photos: null,
                    type: 'popup',
                    navbarOfText: 'из',
                    backLinkText: 'Закрыть',
                }
            }
        },
        methods: {
            submitCreateForm: function () {
                var self = this;
                var app = self.$app;
                var $$ = self.$$;
                var router = app.views.main.router;
                var formData = app.form.convertToData('#object-create-form');
                var objectData = {};
                var photoUrls = self.photoUrls;

                if (!formData.trash_type.length) {
                    self.$root.openNotification('Укажите как минимум один тип мусора.');
                    return;
                }

                objectData = {
                    "description": {
                        "title": "",
                        "description": formData.trash_description
                    },
                    "address": self.userLocation
                };
                config.debug && console.log(objectData, formData);

                if (self.$root.deviceIsOffline()) {
                    // Положить в очередь?
                } else {
                    app.preloader.show();

                    app.request.postJSON(config.slimApiUrl + '/api/objects', objectData, function (success, status) {
                        app.preloader.hide();
                        config.debug && console.log(success, status);

                        if (status === 201) {
                            app.dialog.alert('Красаучег', function() {
                                router.navigate('/objects-list');
                            });
                        }
                    }, function (error, status) {
                        app.preloader.hide();
                        config.debug && console.log(error, status);
                        
                        self.$root.openNotification('Create object error. Code ' + status);
                    });
                }
            },
            changeMapPosition: function () {
                alert()
            },
            updateSliderAfterAdding: function (photoLink, deleteByIndex) {
                var self = this;
                var app = self.$app;
                var $$ = self.$$;
                var isAdding = typeof deleteByIndex === "boolean" && !deleteByIndex;
                // Так как по умолчанию self.photoUrls null то положить в него []
                var currentPhotos = self.photoUrls || [];

                if (isAdding && self.photoUrls && self.photoUrls.length >= 4) {
                    self.$root.openNotification('Вы не можете внести более 4 фотографий.');
                    return;
                }

                config.debug && console.log(currentPhotos, deleteByIndex);

                // Добавить или удалить?
                if (isAdding) {
                    currentPhotos.push(photoLink);
                } else {
                    currentPhotos.splice(deleteByIndex, 1);
                }

                // Virtual DOM state
                self.$setState({
                    photoUrls: currentPhotos
                });

                // Добавить фото в слайдер
                self.photoBrowserSettings.photos = currentPhotos;
                self.myPhotoBrowserPopup = app.photoBrowser.create(self.photoBrowserSettings);
                config.debug && console.log(self);

                // Показать скрытый слайдер после добавления
                if (currentPhotos.length > 0) {
                    $$('.object-photo-slider').removeClass('object-create-slider-hidden');
                    $$('.object-photo-slider-empty').hide();
                    $$('.object-delete-photo').show();
                } else {
                    $$('.object-photo-slider').addClass('object-create-slider-hidden');
                    $$('.object-photo-slider-empty').show();
                    $$('.object-delete-photo').hide();
                }
            },
            handleMapLocateControl: function () {
                var self = this;

                // self.map.locate({
                //     setView: true,
                //     maxZoom: 16,
                //     enableHighAccuracy: true,
                //     maximumAge: 300000
                // });

                var locatecontrol = L.control.locate({
                    icon: 'fas fa-map-marker',
                    iconLoading: 'fas fa-spinner fa-spin',
                    strings: {
                        title: '',
                        popup: 'Вы в радиусе {distance} м. от этой точки',
                    },
                    locateOptions: {
                        maxZoom: 16,
                        enableHighAccuracy: true,
                        maximumAge: 0,
                        timeout: 5000,
                        watch: false,
                    }
                }).addTo(self.map);
                
                // Автоматическое определение при переходе?
                locatecontrol.start();

                self.map.on('locationfound', this.onLocationFound);
                self.map.on('locationerror', this.onLocationError);
            },
            onLocationFound: function (e) {
                var self = this;
                var app = self.$app;
                var $$ = self.$$;
                var radius = e.accuracy;
                var msg = 'Приблизительное расположение в метрах - ' + radius.toFixed(1);
                var nominatimUrl = 'https://nominatim.openstreetmap.org/reverse?lat='+e.latitude+'&lon='+e.longitude+'&format=json';
                // var divIcon = L.divIcon({
                //     className: "leaflet-data-marker",
                //     html: L.Util.template(self.$root.iconSettings.mapIconUrl, self.$root.iconSettings),
                //     iconAnchor  : [12, 12],
                //     iconSize    : [24, 24],
                //     popupAnchor : [0, -24]
                // });

                config.debug && console.log(e);

                // Запросим название локации с помощью open street map
                app.request.json(nominatimUrl, (response) => {
                    config.debug && console.log(response);

                    var formattedLatLng = e.latitude.toFixed(8) + ', ' + e.longitude.toFixed(8);
                    var addressString = [
                        // От высшего
                        response.address.state,
                        response.address.county,
                        response.address.city,
                        response.address.city_district,
                        response.address.road,
                        // До низшего
                        response.address.house_number,
                    ]
                    var displayName = addressString.filter(function(n) { return n; }).join(', ');

                    // Записать локацию для отправки на сервер
                    self.userLocation = {
                        "display_name": displayName,
                        "city": response.address.city || '',
                        "city_district": response.address.city_district || '',
                        "county": response.address.county || '',
                        "state": response.address.state || '',
                        "country": response.address.country || '',
                        "latitude": e.latitude,
                        "longitude": e.longitude
                    };
                    config.debug && console.log(self);
                    
                    $$('#user-location-display-name').text(displayName);
                    $$('.object-coordinates').css('display', 'flex');
                    $$('#user-location-coordinates').text(formattedLatLng);
                });

                // Показать маркер и иконку
                // L.marker(e.latlng, {
                //     icon: divIcon,
                // }).addTo(self.map).bindPopup(msg, {
                //     maxWidth: 230
                // }).openPopup();

                // L.circle(e.latlng, radius, {
                //     weight: 0,
                //     color: '#136AEC'
                // }).addTo(self.map);
            },
            // Ошибка в определении локации
            onLocationError: function (e) {
                var self = this;
                var app = self.$app;
                var msg = 'Определить локацию автоматически не удалось. Попробуйте включить GPS, проверить права приложения или укажите вручную. Ошибка: ' + e.message;
                
                config.debug && console.log(e);
                app.dialog.alert(msg);
            },
            getOptions: function (srcType) {
                return {
                    quality: 80,
                    destinationType: Camera.DestinationType.FILE_URI,
                    sourceType: srcType,
                    encodingType: Camera.EncodingType.JPEG,
                    mediaType: Camera.MediaType.PICTURE,
                    targetWidth: 600,
                    targetHeight: 600,
                    correctOrientation: true,
                };
            },
            cameraSuccess: function (fileURL) {
                var self = this;
                var app = self.$app;
                var $$ = self.$$;

                config.debug && console.log(fileURL);
                self.updateSliderAfterAdding(fileURL, false);
                
                // Получить локацию на мобилке если её еще нет
                if (!self.userLocation && app.device.cordova) {
                    self.handleMapLocateControl();
                }
            },
            cameraError: function (message) {
                var self = this;
                var app = self.$app;

                // Сюда скорее всего прилетит ошибка, что юзер вышел из режима камеры
                // this.$root.openNotification("Unable to obtain picture: " + message);
                config.debug && console.log(message);

                // Получить локацию на мобилке если её еще нет
                if (!self.userLocation && app.device.cordova) {
                    self.handleMapLocateControl();
                }
            },
            launchCamera: function () {
                if (this.$app.device.cordova) {
                    var cameraOptions = this.getOptions(Camera.PictureSourceType.CAMERA);
                    navigator.camera.getPicture(this.cameraSuccess, this.cameraError, cameraOptions);
                } else {
                    var randomnumber = Math.floor(Math.random() * (500 - 300 + 1)) + 300;
                    this.updateSliderAfterAdding('https://placekitten.com/500/'+randomnumber, false);
                }
            },
            selectFromGallery: function () {
                if (this.$app.device.cordova) {
                    var cameraOptions = this.getOptions(Camera.PictureSourceType.SAVEDPHOTOALBUM);
                    navigator.camera.getPicture(this.cameraSuccess, this.cameraError, cameraOptions);
                } else {
                    var randomnumber = Math.floor(Math.random() * (500 - 300 + 1)) + 300;
                    this.updateSliderAfterAdding('https://placekitten.com/500/'+randomnumber, false);
                }
            },
            openPhotoBrowser: function () {
                if (this.myPhotoBrowserPopup) {
                    this.myPhotoBrowserPopup.open();
                }
            },
            deleteVisiblePhoto: function () {
                var self = this;
                var app = self.$app;
                var $$ = self.$$;
                var index = $$('.object-photo-slider')[0].swiper.realIndex;
                config.debug && console.log(index);

                app.dialog.confirm('Вы действительно хотите удалить это фото?', function () {
                    self.updateSliderAfterAdding('', index);
                });
            }
        },
        on: {
            pageInit: function (e, page) {
                var self = this;
                var app = self.$app;
                var $$ = self.$$;

                if (app.device.cordova) {
                    self.launchCamera();
                }

                if (!self.map) {
                    self.map = L.map('user-location', {
                        loadingControl: true,
                        gestureHandling: true,
                    }).setView([54.3185, 48.3978], 12);

                    // L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    //     attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    // }).addTo(self.map);

                    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
                        maxZoom: 18,
                        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                            '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                            'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                        id: 'mapbox.streets'
                    }).addTo(self.map);

                    L.Control.geocoder().addTo(self.map);
                }

                if (!app.device.cordova) {
                    self.handleMapLocateControl();
                }
            },
        }
    }
</script>