<template>
    <div class="page no-toolbar" data-name="object-create">
        <div class="navbar">
            <div class="navbar-inner sliding">
                <div class="left">
                    <a href="#" class="link back">
                        <i class="icon icon-back"></i>
                        <span class="ios-only">Назад</span>
                    </a>
                </div>
                <div class="right">
                    <a href="#" class="link" @click="submitCreateForm">
                        <span>Создать</span>
                    </a>
                </div>
            </div>
        </div>
        <div class="page-content">
        <form id="object-create-form">
            <div class="swiper-add-wrap">
                <div data-pagination='{"el": ".swiper-pagination"}' data-space-between="50" data-observer="true"
                    class="swiper-container swiper-init demo-swiper object-photo-slider object-create-slider-hidden">
                    <div class="swiper-pagination"></div>
                    <div class="swiper-wrapper">
                        {{#each photoUrls}}
                            <div class="swiper-slide">
                                <img src="{{this}}" class="uploaded-camera-image" width="1000" height="200">
                            </div>
                        {{/each}}
                    </div>
                </div>
                <div class="demo-swiper object-photo-slider-empty" style="position: relative;">
                    <div class="swiper-wrapper">
                        <div class="swiper-slide hairline-bottom">
                            Вы должны добавить<br>как минимум одну фотографию
                        </div>
                    </div>
                </div>

                <div class="fab object-add-photo" @click="launchCamera">
                    <a href="#">
                        <i class="f7-icons if-not-md">camera_fill</i>
                        <i class="material-icons md-only">add_a_photo</i>
                    </a>
                </div>
                <div class="fab object-attach-photo" @click="selectFromGallery">
                    <a href="#">
                        <i class="f7-icons if-not-md">attachment</i>
                        <i class="material-icons md-only">attach_file</i>
                    </a>
                </div>
            </div>

            <div class="block-title block-title-medium object-header header-address">
                <span @click="updateSliderAfterAdding('https://placekitten.com/500/500', false)">Адрес</span>
                <a class="link size-16" href="#" @click="changeMapPosition">
                    <span>Изменить точку на карте</span>
                </a>
            </div>
            
            <div class="card">
                <div id="user-location" class="create-object-map"></div>
                <div class="card-content card-content-padding">
                    <span id="user-location-display-name">Выберите локацию и адрес появится здесь</span>
                </div>
                <div class="card-footer object-coordinates">
                    <i class="f7-icons if-not-md size-20">home</i>
                    <i class="material-icons md-only size-20">place</i>
                    <span id="user-location-coordinates"></span>
                </div>
            </div>

            <div class="block-title block-title-medium object-header">Количество мусора</div>
            <div class="list">
                <ul>
                    <li>
                        <label class="item-radio item-content">
                            <input type="radio" name="trash_size" value="Мешок" checked>
                            <i class="icon icon-radio"></i>
                            <div class="item-inner">
                                <div class="item-title">Мешок</div>
                            </div>
                        </label>
                    </li>
                    <li>
                        <label class="item-radio item-content">
                            <input type="radio" name="trash_size" value="Тачка">
                            <i class="icon icon-radio"></i>
                            <div class="item-inner">
                                <div class="item-title">Тачка</div>
                            </div>
                        </label>
                    </li>
                    <li>
                        <label class="item-radio item-content">
                            <input type="radio" name="trash_size" value="Машина">
                            <i class="icon icon-radio"></i>
                            <div class="item-inner">
                                <div class="item-title">Машина</div>
                            </div>
                        </label>
                    </li>
                </ul>
            </div>

            <div class="block-title block-title-medium object-header">Тип мусора</div>
            <div class="list">
                <ul>
                    <li>
                        <label class="item-checkbox item-content">
                            <input type="checkbox" name="trash_type" value="Бычки" />
                            <i class="icon icon-checkbox"></i>
                            <div class="item-inner">
                                <div class="item-title">Бычки</div>
                            </div>
                        </label>
                    </li>
                    <li>
                        <label class="item-checkbox item-content">
                            <input type="checkbox" name="trash_type" value="Бумага" />
                            <i class="icon icon-checkbox"></i>
                            <div class="item-inner">
                                <div class="item-title">Бумага</div>
                            </div>
                        </label>
                    </li>
                    <li>
                        <label class="item-checkbox item-content">
                            <input type="checkbox" name="trash_type" value="Продукты" />
                            <i class="icon icon-checkbox"></i>
                            <div class="item-inner">
                                <div class="item-title">Продукты</div>
                            </div>
                        </label>
                    </li>
                    <li>
                        <label class="item-checkbox item-content">
                            <input type="checkbox" name="trash_type" value="Стекло" />
                            <i class="icon icon-checkbox"></i>
                            <div class="item-inner">
                                <div class="item-title">Стекло</div>
                            </div>
                        </label>
                    </li>
                    <li>
                        <label class="item-checkbox item-content">
                            <input type="checkbox" name="trash_type" value="Металл" />
                            <i class="icon icon-checkbox"></i>
                            <div class="item-inner">
                                <div class="item-title">Металл</div>
                            </div>
                        </label>
                    </li>
                    <li>
                        <label class="item-checkbox item-content">
                            <input type="checkbox" name="trash_type" value="Строительный" />
                            <i class="icon icon-checkbox"></i>
                            <div class="item-inner">
                                <div class="item-title">Строительный</div>
                            </div>
                        </label>
                    </li>
                </ul>
            </div>

            <div class="block-title block-title-medium object-header">Дополнительная информация</div>
            <div class="list no-hairlines-md">
                <ul>
                    <li class="item-content item-input">
                        <div class="item-inner no-padding-top">
                            <div class="item-input-wrap">
                                <textarea placeholder="Рядом остановка морг; это около шаурмечной; оно мешает моей собаке..." name="trash_description"></textarea>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </form>
        </div>
    </div>
</template>
<script>
    import * as config from '../../config';

    export default {
        data: function () {
            return {
                // empty initial object
                object: null,
                // created photos here (fileUri://)
                photoUrls: null,
                // instance of photo browser
                myPhotoBrowserPopup: null,
                // user geolocation here
                userLocation: null,
                // map html object
                map: null,
                // photo browser gallery
                photoBrowserSettings: {
                    photos: null,
                    type: 'popup',
                    navbarOfText: 'из',
                    backLinkText: 'Закрыть',
                    renderToolbar: function () {
                        const toolbarHtml = `
                            <div class="toolbar toolbar-bottom tabbar">
                                <div class="toolbar-inner">
                                    <a class="link photo-browser-prev">
                                        <i class="icon icon-back"></i>
                                    </a>
                                    <a tabindex="0" role="button" class="link object-delete-photo">
                                        <i class="f7-icons if-not-md">trash_fill</i>
                                        <i class="material-icons md-only">delete_forever</i>
                                    </a>
                                    <a class="link photo-browser-next">
                                        <i class="icon icon-forward"></i>
                                    </a>
                                </div>
                            </div>
                        `.trim();

                        return toolbarHtml;
                    }
                }
            }
        },
        methods: {
            submitCreateForm: function () {
                var self = this;
                var app = self.$app;
                var $$ = self.$$;
                var router = app.views.main.router;
                var formData = app.form.convertToData('#object-create-form');
                var objectData = {};

                if (!formData.trash_type.length) {
                    self.$root.openNotification('Укажите как минимум один тип мусора.');
                    return;
                }

                objectData = {
                    "description": {
                        "title": "",
                        "description": formData.trash_description
                    },
                    "address": self.userLocation
                };
                console.log(objectData, self.photoUrls, self.userLocation);

                if (self.$root.deviceIsOffline()) {
                    // Положить в очередь?
                } else {
                    app.preloader.show();

                    app.request.postJSON(config.slimApiUrl + '/api/objects', objectData, function (success, status) {
                        app.preloader.hide();

                        if (status === 201) {
                            app.dialog.alert('Красаучег', function() {
                                router.navigate('/objects-list');
                            });
                        }
                    }, function (error, status) {
                        app.preloader.hide();
                        
                        self.$root.openNotification('Create object error. Code ' + status);
                    });
                }
            },
            changeMapPosition: function () {
                alert()
            },
            updateSliderAfterAdding: function (photoLink, deleteByIndex) {
                var self = this;
                var app = self.$app;
                var $$ = self.$$;
                var isAdding = typeof deleteByIndex === "boolean" && !deleteByIndex;
                // Так как по умолчанию self.photoUrls null то положить в него []
                var currentPhotos = self.photoUrls || [];

                if (isAdding && self.photoUrls && self.photoUrls.length >= 4) {
                    self.$root.openNotification('Вы не можете внести более 4 фотографий.');
                    return;
                }

                // Добавить или удалить?
                if (isAdding) {
                    currentPhotos.push(photoLink);
                } else {
                    currentPhotos.splice(deleteByIndex, 1);
                }

                // Virtual DOM state
                self.$setState({
                    photoUrls: currentPhotos
                });

                // Добавить фото в слайдер
                self.photoBrowserSettings.photos = currentPhotos;
                self.myPhotoBrowserPopup = app.photoBrowser.create(self.photoBrowserSettings);

                // Показать скрытый слайдер после добавления
                if (currentPhotos.length > 0) {
                    $$('.object-photo-slider').removeClass('object-create-slider-hidden');
                    $$('.object-photo-slider-empty').hide();
                } else {
                    $$('.object-photo-slider').addClass('object-create-slider-hidden');
                    $$('.object-photo-slider-empty').show();
                }
            },
            getMapLocation: function () {
                var self = this;

                self.map.locate({
                    setView: true,
                    maxZoom: 16,
                    enableHighAccuracy: true,
                    maximumAge: 300000
                });

                self.map.on('locationfound', this.onLocationFound);
                self.map.on('locationerror', this.onLocationError);
            },
            onLocationFound: function (e) {
                var self = this;
                var app = self.$app;
                var $$ = self.$$;
                var radius = e.accuracy;
                var msg = 'Приблизительное расположение в метрах - ' + radius.toFixed(1);
                var nominatimUrl = 'https://nominatim.openstreetmap.org/reverse?lat='+e.latitude+'&lon='+e.longitude+'&format=json';
                var divIcon = L.divIcon({
                    className: "leaflet-data-marker",
                    html: L.Util.template(self.$root.iconSettings.mapIconUrl, self.$root.iconSettings),
                    iconAnchor  : [12, 12],
                    iconSize    : [24, 24],
                    popupAnchor : [0, -24]
                });

                // Запросим название локации с помощью open street map
                app.request.json(nominatimUrl, (response) => {
                    console.log(response);
                    var formattedLatLng = e.latitude.toFixed(8) + ', ' + e.longitude.toFixed(8);
                    var addressString = [
                        // От высшего
                        response.address.state,
                        response.address.county,
                        response.address.city,
                        response.address.city_district,
                        response.address.road,
                        // До низшего
                        response.address.house_number,
                    ]
                    var displayName = addressString.filter(function(n) { return n; }).join(', ');

                    // Записать локацию для отправки на сервер
                    self.userLocation = {
                        "display_name": displayName,
                        "city": response.address.city || '',
                        "city_district": response.address.city_district || '',
                        "county": response.address.county || '',
                        "state": response.address.state || '',
                        "country": response.address.country || '',
                        "latitude": e.latitude,
                        "longitude": e.longitude
                    };

                    $$('#user-location-display-name').text(displayName);
                    $$('.object-coordinates').css('display', 'flex');
                    $$('#user-location-coordinates').text(formattedLatLng);
                });

                // Показать маркер и иконку
                L.marker(e.latlng, {
                    icon: divIcon,
                }).addTo(self.map).bindPopup(msg, {
                    maxWidth: 230
                }).openPopup();

                L.circle(e.latlng, radius, {
                    weight: 0,
                    color: '#136AEC'
                }).addTo(self.map);
            },
            // Ошибка в определении локации
            onLocationError: function (e) {
                var self = this;
                var app = self.$app;
                var msg = 'Определить локацию автоматически не удалось. Попробуйте включить GPS, проверить права приложения или укажите вручную. Ошибка: ' + e.message;

                app.dialog.alert(msg);
            },
            getOptions: function (srcType) {
                return {
                    quality: 80,
                    destinationType: Camera.DestinationType.FILE_URI,
                    sourceType: srcType,
                    encodingType: Camera.EncodingType.JPEG,
                    mediaType: Camera.MediaType.PICTURE,
                    targetWidth: 600,
                    targetHeight: 600,
                    correctOrientation: true,
                };
            },
            cameraSuccess: function (fileURL) {
                var self = this;
                var app = self.$app;
                var $$ = self.$$;

                self.updateSliderAfterAdding(fileURL, false);

                // Получить локацию на мобилке если её еще нет
                if (!self.userLocation && app.device.cordova) {
                    self.getMapLocation();
                }
            },
            cameraError: function (message) {
                var self = this;
                var app = self.$app;

                // Сюда скорее всего прилетит ошибка, что юзер вышел из режима камеры
                this.$root.openNotification("Unable to obtain picture: " + message);

                // Получить локацию на мобилке если её еще нет
                if (!self.userLocation && app.device.cordova) {
                    self.getMapLocation();
                }
            },
            launchCamera: function () {
                var cameraOptions = this.getOptions(Camera.PictureSourceType.CAMERA);
                navigator.camera.getPicture(this.cameraSuccess, this.cameraError, cameraOptions);
            },
            selectFromGallery: function () {
                var cameraOptions = this.getOptions(Camera.PictureSourceType.SAVEDPHOTOALBUM);
                navigator.camera.getPicture(this.cameraSuccess, this.cameraError, cameraOptions);
            },
        },
        on: {
            pageInit: function () {
                var self = this;
                var app = self.$app;
                var $$ = self.$$;

                if (app.device.cordova) {
                    self.launchCamera();
                }

                $$(document).on('click', '.uploaded-camera-image', function () {
                    self.myPhotoBrowserPopup.open();
                });

                $$(document).on('click', '.object-delete-photo', function () {
                    app.dialog.confirm('Вы действительно хотите удалить это фото?', function () {
                        var index = self.myPhotoBrowserPopup.activeIndex;
                        
                        self.myPhotoBrowserPopup.close();
                        self.updateSliderAfterAdding('', index);
                    });
                });

                if (!self.map) {
                    self.map = L.map('user-location', {
                        loadingControl: true,
                        gestureHandling: true,
                        // zoom: 10,
                    }).fitWorld();

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(self.map);

                    L.Control.geocoder().addTo(self.map);
                }

                if (!app.device.cordova) {
                    self.getMapLocation();
                }
            },
        }
    }
</script>