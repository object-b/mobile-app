<template>
    <div class="page" data-name="objects-map">
        <div class="navbar">
            <div class="navbar-inner sliding">
                <div class="title">Карта объектов</div>
            </div>
        </div>
        <div class="page-content">
            <div id="global-map" class="global-object-map"></div>
        </div>

        <div class="fab fab-right-bottom">
            <a href="/create-object">
                <i class="icon f7-icons">add</i>
            </a>
        </div>
    </div>
</template>
<script>
    import * as locationPermissions from '../../js/location-permissions';

    export default {
        data: function () {
            return {
                // user geolocation here
                userLocation: null,
                // map html object
                map: null,
                // leaflet plugin object
                locatecontrol: null,
            }
        },
        methods: {
            checkPermissionAndLocate: function() {
                var self = this;
                var app = self.$app;

                if (app.device.cordova) {
                    locationPermissions.init(function() {
                        // Автоматическое определение при успехе
                        self.locatecontrol.start();
                    }, function(error) {
                        app.dialog.confirm(error, locationPermissions.openSettings);
                        self.locatecontrol.stop();
                    });
                } else {
                    self.locatecontrol.start();
                }
            },
            onLocationFound: function (e) {
                var self = this;
                var app = self.$app;

                self.userLocation = {
                    latitude: e.latitude,
                    longitude: e.longitude,
                };
                
                app.data.config.debug && console.log(self.userLocation);
            },
            onLocationError: function (e) {
                var self = this;
                var app = self.$app;

                app.data.config.debug && console.log(e);

                self.$root.openNotification('Определить локацию не удалось.');

                // Проверить состояние пермишенов еще раз
                // locationPermissions.init(cordova, function() {
                //     // Автоматическое определение при успехе
                //     self.locatecontrol.start();
                // }, function(error) {
                //     self.$root.openNotification(error);
                // });
            },
            getRadiusFromMapCenter: function(unit) {
                var self = this;
                var mapBoundNorthEast = self.map.getBounds().getNorthEast();
                var mapDistance = mapBoundNorthEast.distanceTo(self.map.getCenter());
                var meters = (mapDistance).toFixed(2);
                var kilometers = (mapDistance / 1000).toFixed(2);

                return unit === 'km' ? kilometers : unit === 'm' ? meters : '';
            },
        },
        on: {
            pageInit: function (e, page) {
                var self = this;
                var app = self.$app;
                var $$ = self.$$;
                var objectsGetMarkers = app.data.config.apiMarkersUrl;
                var allMarkers = [];

                //if (!self.map) {
                var tiles = self.$root.createMapTiles();

                // Создание экземпляра объекта карты с использованием идентификатора DOM элемента <div> и, необязательно, литерала объекта с параметрами карты.
                self.map = L.map('global-map', {
                    zoomControl: true,
                    loadingControl: true,
                    gestureHandling: false,
                    minZoom: 8,
                    maxZoom: 17,
                    layers: [tiles]
                }).setView(self.$root.defaultMapCenter, 12);

                var markerCluster = L.markerClusterGroup({
                    chunkedLoading: true,
                    spiderfyOnMaxZoom: false,
                    removeOutsideVisibleBounds: false,
                });

                // Срабатывает, когда карта перестает меняться (например, пользователь перестал перетаскивать карту).
                self.map.on('moveend', function (e) {
                    var latLngRaduisCenter = {
                        radius: self.getRadiusFromMapCenter('km'),
                        lat: self.map.getCenter().lat,
                        lng: self.map.getCenter().lng,
                    };
                    
                    app.data.config.debug && console.log(latLngRaduisCenter);
                    // config.debug && L.marker(self.map.getCenter()).addTo(self.map);
                    // config.debug && L.circle(
                    //     self.map.getCenter(), 
                    //     parseInt(self.getRadiusFromMapCenter('m'))
                    // ).addTo(self.map);

                    // Нужно получить точки только на видимой области карты
                    app.request.json(objectsGetMarkers, latLngRaduisCenter, (addressPoints) => {
                        markerCluster.clearLayers(allMarkers);

                        for (var i = 0; i < addressPoints.length; i++) {
                            var current = addressPoints[i];
                            var title = current[2];
                            var marker = L.marker(new L.LatLng(current[0], current[1]), {
                                title: title
                            });
                            
                            allMarkers.push(marker);
                            marker.bindPopup(title);
                            
                            markerCluster.addLayer(marker);
                        }

                        self.map.addLayer(markerCluster);
                    });
                });

                // Кастомная кнопка геолокации
                app.data.locateControlOptions.createButtonCallback = function (container, options) {
                    var fab = L.DomUtil.create('div', 'fab fab-right-bottom locate-control-start', container);
                    var href = L.DomUtil.create('span', '', fab);
                    var icon = L.DomUtil.create('i', '', href);

                    if (app.device.ios) {
                        L.DomUtil.get(icon).innerHTML = '<span>navigation_fill</span>';
                    } else {
                        L.DomUtil.get(icon).innerHTML = '<span>my_location</span>';
                    }

                    return { link: fab, icon: icon };
                };

                self.locatecontrol = L.control.locate(app.data.locateControlOptions).addTo(self.map);
                self.map.on('locationfound', self.onLocationFound);
                self.map.on('locationerror', self.onLocationError);

                // Проверить состояние пермишенов при переходе
                self.checkPermissionAndLocate();

                self.locatecontrol._link.onclick = self.checkPermissionAndLocate;
            },
        }
    };
</script>