<template>
    <div class="page" data-name="objects-map">
        <div class="navbar">
            <div class="navbar-inner sliding">
                <div class="title">Карта</div>
            </div>
        </div>
        <div class="page-content">
            <div id="global-map" class="global-object-map"></div>
        </div>

        <div class="fab fab-right-bottom start-locate">
            <a href="#">
                <i class="icon f7-icons if-not-md">placemark_fill</i>
                <i class="icon material-icons if-md size-26">my_location</i>
            </a>
        </div>

        <div class="fab fab-right-bottom">
            <a href="/create-object">
                <i class="icon f7-icons if-not-md">add</i>
                <i class="icon material-icons if-md size-26">add_location</i>
            </a>
        </div>
    </div>
</template>
<script>
    import * as locationPermissions from '../../js/location-permissions';

    export default {
        data: function () {
            return {
                userLocation: null,
                map: null,
                locatecontrol: null,
                markerCluster: null,
            }
        },
        methods: {
            updateButtonState: function(state) {
                var $$ = this.$$;

                if (state == 'loading') {
                    $$('.start-locate i').addClass('loading-anim');
                } else if (state == 'stop') {
                    $$('.start-locate i').removeClass('loading-anim');
                }
            },
            runLocateControl: function() {
                var self = this;
                var app = self.$app;

                self.locatecontrol.stop();
                self.locatecontrol.start();

                self.map.on('locationfound', self.onLocationFound);
                self.map.on('locationerror', self.onLocationError);
            },
            checkLocationPermissions: function() {
                var self = this;
                var app = self.$app;

                self.updateButtonState('loading');

                if (app.device.cordova) {
                    locationPermissions.init(self.runLocateControl, function(error) {
                        console.log(error);
                        self.updateButtonState('stop');
                        self.$root.openNotification('Ошибка получения прав на определение локации.');
                    });
                } else {
                    setTimeout(self.runLocateControl, 2000);
                }
            },
            onLocationFound: function (e) {
                var self = this;
                var app = self.$app;

                self.userLocation = {
                    latitude: e.latitude,
                    longitude: e.longitude,
                };

                self.updateButtonState('stop');

                app.data.config.debug && console.log(self.userLocation);
            },
            onLocationError: function (e) {
                var self = this;
                var app = self.$app;

                app.data.config.debug && console.log(e);

                self.updateButtonState('stop');

                // Geolocation error: Illegal Access.
                if (e.code !== 1) {
                    self.$root.openNotification('Определить локацию не удалось.');
                }
            },
            getRadiusFromMapCenter: function(unit) {
                var self = this;
                var mapBoundNorthEast = self.map.getBounds().getNorthEast();
                var mapDistance = mapBoundNorthEast.distanceTo(self.map.getCenter());
                var meters = (mapDistance).toFixed(2);
                var kilometers = (mapDistance / 1000).toFixed(2);

                return unit === 'km' ? kilometers : unit === 'm' ? meters : '';
            },
            getMarkersInRadius: function() {
                var self = this;
                var app = self.$app;
                var latLngRaduisCenter = {
                    radius: self.getRadiusFromMapCenter('km'),
                    lat: self.map.getCenter().lat,
                    lng: self.map.getCenter().lng,
                };
                var objectsGetMarkers = app.data.config.apiMarkersUrl;
                var allMarkers = [];

                app.data.config.debug && console.log(latLngRaduisCenter);
                // config.debug && L.marker(self.map.getCenter()).addTo(self.map);
                // config.debug && L.circle(
                //     self.map.getCenter(),
                //     parseInt(self.getRadiusFromMapCenter('m'))
                // ).addTo(self.map);

                // Нужно получить точки только на видимой области карты
                app.request.json(objectsGetMarkers, latLngRaduisCenter, (addressPoints) => {
                    self.markerCluster.clearLayers(allMarkers);

                    for (var i = 0; i < addressPoints.length; i++) {
                        var current = addressPoints[i];
                        var title = current[2];
                        var marker = L.marker(new L.LatLng(current[0], current[1]), {
                            title: title
                        });

                        allMarkers.push(marker);
                        marker.bindPopup(title);

                        self.markerCluster.addLayer(marker);
                    }

                    self.map.addLayer(self.markerCluster);
                });
            },
        },
        on: {
            pageInit: function (e, page) {
                var self = this;
                var app = self.$app;
                var $$ = self.$$;
                var tiles = self.$root.createMapTiles();

                // Создание экземпляра объекта карты с использованием id DOM элемента
                self.map = L.map('global-map', {
                    zoomControl: true,
                    loadingControl: true,
                    gestureHandling: false,
                    minZoom: 8,
                    maxZoom: 17,
                    layers: [tiles]
                }).setView(self.$root.defaultMapCenter, 12);

                self.markerCluster = L.markerClusterGroup({
                    chunkedLoading: true,
                    spiderfyOnMaxZoom: false,
                    removeOutsideVisibleBounds: false,
                });

                // Карта перестает меняться (например, пользователь перестал перетаскивать карту).
                self.map.on('moveend', self.getMarkersInRadius);

                // Плагин для определения локации
                self.locatecontrol = L.control.locate(app.data.locateControlOptions).addTo(self.map);

                page.$el.on('click', '.start-locate', self.checkLocationPermissions);

                // В радиусе дефолтной карты можно получить маркеры сразу
                self.getMarkersInRadius();

                // Проверить состояние пермишенов при переходе
                // self.checkLocationPermissions();
            },
        }
    };
</script>